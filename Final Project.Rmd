---
title: "PSTAT-175-Final-Project"
author: "William Nelson"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

You want to write up your project as a report. It should look like something you can read with sentences\
and paragraphs. It should not be a series of answers to my questions like the homework assignment. You\
should have sections that are numbered, but those sections should relate to the analysis that you are doing in your model

# Final Project

## 1: Introduction

We will be analyzing the "GRACE1000" dataset from Hosmer and Lemenshow and May (2008), which contains data on 1000 patients who were part of a study on the effectiveness of revascularization by the Global Registry of Acute Coronary Events (GRACE). Our failure time of interest is the follow up time when the researchers checked-in with the patients, and our event of interest is whether the patient died during the follow-up period. Our main covariate of interest will be whether the patient had the revascularization procedure performed on them, which is coded by the "revasc" variable with value 1 if the patient had the procedure and 0 if they did not. The main research question of interest is whether revascularization is associated with higher survival rates after admission.

Here is a plot of the survival functions of patients who had the revascularization procedure in blue and patients who did not have the procedure done in red:

```{r}
ggsurvplot(survfit(Surv(days,death) ~ revasc, data = GRACE1000))
```

We can see that patients who had revascularization done appear to have a higher survival probability compared to patients who did not have the procedure done.

### 1.1: Citations

## 2: Model Fitting

```{r, message=FALSE, warning=FALSE}
library(readr)
library(tidyverse)
library(survival)
library(survminer)
library(ggplot2)
GRACE1000 <- read_table("C:/Users/willi/OneDrive/Documents/GitHub/PSTAT175-Final/GRACE1000.dat", col_names = FALSE)
GRACE1000 <- GRACE1000 %>% select(-X10)
colnames(GRACE1000) <- c("id", "days", "death", "revasc", "revascdays", "los", "age", "sysbp", "stchange")
```

```{r}
# Forward Stepwise Selection
# Possible covariates are revasc, revascdays, sysbp, age, stchange, los
# Included revascdays despite it being equal to days if no revasc happened

revdays.mod <- coxph(Surv(days,death) ~ revascdays, data = GRACE1000)
age.mod <- coxph(Surv(days,death) ~ age, data = GRACE1000)
sysbp.mod <- coxph(Surv(days,death) ~ sysbp, data = GRACE1000)
stchange.mod <- coxph(Surv(days,death) ~ stchange, data = GRACE1000)
los.mod <- coxph(Surv(days,death) ~ los, data = GRACE1000)
revasc.mod <- coxph(Surv(days,death) ~ revasc, data = GRACE1000)

AIC(revdays.mod, age.mod, sysbp.mod, stchange.mod, los.mod, revasc.mod)
BIC(revdays.mod, age.mod, sysbp.mod, stchange.mod, los.mod, revasc.mod)
# Lowest AIC (4151.309) and BIC (4155.090) is age
```

```{r}
age.revdays.mod <- coxph(Surv(days,death) ~ age + revascdays, data = GRACE1000)
age.sysbp.mod <- coxph(Surv(days,death) ~ age + sysbp, data = GRACE1000)
age.stchange.mod <- coxph(Surv(days,death) ~ age + stchange, data = GRACE1000)
age.los.mod <- coxph(Surv(days,death) ~ age + los, data = GRACE1000)
age.revasc.mod <- coxph(Surv(days,death) ~ age + revasc, data = GRACE1000)

AIC(age.revdays.mod, age.sysbp.mod, age.stchange.mod, age.los.mod, age.revasc.mod)
BIC(age.revdays.mod, age.sysbp.mod, age.stchange.mod, age.los.mod, age.revasc.mod)
# Lowest AIC (4043.699) and BIC (4051.261) is revascdays + age
```

```{r}
revdays.age.sysbp.mod <- coxph(Surv(days,death) ~ revascdays + age + sysbp, data = GRACE1000)
revdays.age.stchange.mod <- coxph(Surv(days,death) ~ revascdays + age + stchange, data = GRACE1000)
revdays.age.los.mod <- coxph(Surv(days,death) ~ revascdays + age + los, data = GRACE1000)
revdays.age.revasc.mod <- coxph(Surv(days,death) ~ revascdays + age + revasc, data = GRACE1000)

AIC(revdays.age.sysbp.mod, revdays.age.stchange.mod, revdays.age.los.mod, revdays.age.revasc.mod)
BIC(revdays.age.sysbp.mod, revdays.age.stchange.mod, revdays.age.los.mod, revdays.age.revasc.mod)
# Lowest AIC (3701.919) and BIC (3713.261) is revasc + revascdays + age
# drops so much because revasc + revascdays together means if revasc = 0, it predicts
# the days outcome as 180 perfectly 
```

```{r}
revasc.revdays.age.sysbp.mod <- coxph(Surv(days,death) ~ revasc + revascdays + age + sysbp, data = GRACE1000)
revasc.revdays.age.stchange.mod <- coxph(Surv(days,death) ~ revasc + revascdays + age + stchange, data = GRACE1000)
revasc.revdays.age.los.mod <- coxph(Surv(days,death) ~ revasc + revascdays + age + los, data = GRACE1000)

AIC(revasc.revdays.age.sysbp.mod, revasc.revdays.age.stchange.mod, revasc.revdays.age.los.mod)
BIC(revasc.revdays.age.sysbp.mod, revasc.revdays.age.stchange.mod, revasc.revdays.age.los.mod)
# Lowest AIC (3697.444) and BIC (3712.567) is sysbp + revasc + revascdays + age
# very close to los with AIC of 3697.495 and BIC of 3712.618
```

```{r}
sysbp.revasc.revdays.age.stchange.mod <- coxph(Surv(days,death) ~ sysbp + revasc + revascdays + age + stchange, data = GRACE1000)
sysbp.revasc.revdays.age.los.mod <- coxph(Surv(days,death) ~ sysbp + revasc + revascdays + age + los, data = GRACE1000)

AIC(sysbp.revasc.revdays.age.stchange.mod, sysbp.revasc.revdays.age.los.mod)
BIC(sysbp.revasc.revdays.age.stchange.mod, sysbp.revasc.revdays.age.los.mod)
# Lowest AIC (3696.180) and BIC (3711.925) is los + sysbp + revasc + revascdays + age
```

```{r}
# See if stchange lowers AIC and BIC
all.mod <- coxph(Surv(days,death) ~ stchange + sysbp + los + revasc + revascdays + age, data = GRACE1000)
AIC(all.mod) # 3691.309 lowers
BIC(all.mod) # 3713.994 raises, stchange not needed by BIC criterion 

# According to forward stepwise selection by AIC, the full model is the best model
# According to BIC, the model with all covariates except stchange is the best model
# Maybe go with BIC to not have all covariates?
```

## 3: Check Proportional Hazards Assumptions

Log-Log plot for revasc:

```{r}
ggsurvplot(survfit(Surv(days,death) ~ revasc, data = GRACE1000),
           fun = "cloglog") + 
  labs(x = "log(Days)", y = "Complementary Log-Log",
       title = "Log-Log Plot by Revasc")
# Seems very parallel, no assumptions violated
```

Log-Log plot for stchange? might not include because BIC says not to

```{r}
ggsurvplot(survfit(Surv(days,death) ~ stchange, data = GRACE1000),
           fun = "cloglog") + 
  labs(x = "log(Days)", y = "Complementary Log-Log",
       title = "Log-Log Plot by Stchange")
# also very parallel lines, no assumptions violated
```

ZPH plot for age:

```{r}
cox.zph(age.mod)
plot(cox.zph(age.mod))
# has significant p-value but plot does 
# not appear to have strong trend
```

```{r}
cox.zph(sysbp.mod)
plot(cox.zph(sysbp.mod))
# The zph test gives a significant p-value which means sysbp violates
# proportional hazards assumption due to time dependency 
# but plot does not seem to have a clear correlation
```

```{r}
cox.zph(los.mod)
plot(cox.zph(los.mod))
# time variable so makes sense it has very small p-value
```

```{r}
cox.zph(revdays.mod)
plot(cox.zph(revdays.mod))
# Definitely violates ph assumptions due to way it is coded
```

## 4: Conclusions

Hazard Ratios

95% confidence intervals for hazard ratios

Our main scientific question of interest is whether the revascularization procedure significantly increases patients' survival probabilities

```{r}
# Revasc:

summary(revasc.mod)
# Hazard ratio is exp(coef) = 0.4892
# means over 50% less likely to die with revasc
exp(coef(revasc.mod) + c(-1.96,1.96) * sqrt(revasc.mod$var[1,1]))
exp(confint(revasc.mod))
# 95% confidence interval is [0.3909648, 0.6122096]
```

```{r}
# stchange

summary(stchange.mod)
# Hazard ratio = 1.6802
# means almost 70% more likely to die with stchange?
exp(coef(stchange.mod) + c(-1.96,1.96) * sqrt(stchange.mod$var[1,1]))
exp(confint(stchange.mod))
# 95% confidence interval is [1.332036, 2.119339]
```

## 5: Advanced Methods

***--------\>Time-varying covariates*** \<-------

-   Modifiying to have start time as revascdays

    -   or split to have a second observation per patient?

    Stratify on stchange?
    -> Did not affect model with just revasc much

-   Time varying covariate: 

    -   revasc(t) = 0 if t \<= revascdays or revasc = 0

    -   revasc(t) = 1 if t \> revascdays and revasc = 1

    -   From Textbook pages:

        -   For example, suppose a subject underwent revascularization on day 4 and died on day 10. In the naive analysis, all 10 days of follow up are attributed to survival after revascularization. In the correct time-varying approach, days 0 to 4 are counted toward survival without revascularization and 5 to 10 days are counted toward survival with revascularization (i.e., revasc(t) = 0 for t \<= 4 and revasc(t) = 1 for t \> 4).

Split patients with revasc into 2 observations with start stop: start = 0, stop = revascdays for first
start = revascdays, stop = days for second observation
patients without revasc are not split at all: start = 0, stop = days
best way to do it would to be to subset dataset of just revasc = 1 patients, split observations into 2 by revascdays, and rejoin with revasc = 0 patients who now have start = 0, stop = days

-   Also from textbook:

    -   Split revascdays into 0.5-1 and 2-14 -\> only days 0 and 1 are significant
    -   Can consider this after doing time-varying covariate for revascdays

```{r}
# Not very important
revasc.strata.mod <- coxph(Surv(days,death) ~ strata(stchange) + revasc, data = GRACE1000)
summary(revasc.strata.mod)
# about the same as without strata
# actually makes revasc a small bit more significant but not much
```

## References

Hosmer, D.W. and Lemeshow, S. and May, S. (2008) Applied Survival Analysis: Regression Modeling of Time to Event Data: Second Edition, John Wiley and Sons Inc., New York, NY
